<!DOCTYPE html>
<html lang="es-VE">
<head>
    <base href="..">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <?php   
        include '../controller.php';
        $rate = getRate()->value;

        $xpayctanro = (isset($_POST['xpayctanro']) && $_POST['xpayctanro'] != '') ? $_POST['xpayctanro'] : null;
        $genera_factura = (isset($_POST['genera_factura']) && $_POST['genera_factura'] != '') ? $_POST['genera_factura'] : 'N';
        $lleva_monto = (isset($_POST['lleva_monto']) && $_POST['lleva_monto'] != '') ? $_POST['lleva_monto'] : 'N';
        $monto_final = (isset($_POST['monto-final']) && $_POST['monto-final'] != '') ? $_POST['monto-final'] : null;
        $concepto = (isset($_POST['concepto']) && $_POST['concepto'] != '') ? $_POST['concepto'] : null;
        $referencia = (isset($_POST['referencia']) && $_POST['referencia'] != '') ? $_POST['referencia'] : null;
        $fchemision = (isset($_POST['fchemision']) && $_POST['fchemision'] != '') ? $_POST['fchemision'] : null;
        $fchcaducidad = (isset($_POST['fchcaducidad']) && $_POST['fchcaducidad'] != '') ? $_POST['fchcaducidad'] : null;
        $nrousuario = (isset($_POST['nrousuario']) && $_POST['nrousuario'] != '') ? $_POST['nrousuario'] : null;
        $email_notificacion = (isset($_POST['email_notificacion']) && $_POST['email_notificacion'] != '') ? $_POST['email_notificacion'] : null;
        $cod_tel     = (isset($_POST['codtel']) && $_POST['codtel'] != '') ? $_POST['codtel'] : '-';
        $telefono    = (isset($_POST['telefono']) && $_POST['telefono'] != '') ? $_POST['telefono'] : '-';
        $monto_modificable = (isset($_POST['monto_modificable']) && $_POST['monto_modificable'] != '') ? $_POST['monto_modificable'] : null;

        $fchemision_fix = date('Y-m-d\TH:i:s-04:00', strtotime($fchemision));
        $fchcaducidad_fix = date('Y-m-d\TH:i:s-04:00', strtotime($fchcaducidad));
        $monto_modificable_fix = $monto_modificable == 'on' ? 'S' : 'N';

        $data = array(
            "ciaopr"=> $ciaopr,
            "xpayctanro"=>$xpayctanro,
            "nrousuario"=>intval($nrousuario),
            "genera_factura"=>$genera_factura,
            "enviado_a_tlf"=>'N',
            "enviado_a_mail" => 'N',
            "lleva_monto" => $lleva_monto,
            "monto"=> floatval($monto_final),
            "monto_modificable"=> $monto_modificable_fix,
            "concepto"=>$concepto,
            "referencia"=>$referencia,
            "fchemision"=>$fchemision_fix,
            "fchcaducidad"=>$fchcaducidad_fix,
            "email_notificacion"=>$email_notificacion,
            "nro_sms_notificacion" => "$cod_tel$telefono",
            "nro_ws_notificacion" => "$cod_tel$telefono",
        );

        $resp = enviarSolicitud($data);
        
        $error = true;
        if (isset($resp->link_url)) {
            $error = false;
        }
        
    ?>
    <title>Solicitud Enviada</title>

    <!-- MANIFEST -->
    <link rel="manifest" href="./manifest.json" />
    <link rel="icon" type="image/x-icon" href="./favicon.ico">

    <!-- BOOTSTRAP -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- FONTAWESOME -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:ital,wght@0,100..900;1,100..900&family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">

    <!-- CSS -->
    <link rel="stylesheet" href="./css/root.css?v=<?=$FILE_VER?>">
    <link rel="stylesheet" href="./css/styles.css?v=<?=$FILE_VER?>">
    <link rel="stylesheet" href="./css/enviolote.css?v=<?=$FILE_VER?>">

</head>
<body>


<div class="container-fluid">

<div class="container-mobile">
    
    <?php
        include '../menu-hamb.html';
    ?>

    <div class="row px-0">
        <div class="col-12">
            <div class="mt-2">
                <?php if (!$error) : ?>
                    <div class="seccion-ml">
                        <div class="title-seccion-ml lh-12">
                            La solicitud de pago fue enviada exitosamente
                        </div>
                        <div class="body-seccion-ml p-2">
                            <div class="txt-explicativo">
                                El siguiente link fu√© enviado al correo electronico proporcionado:

                            </div>
                            <div class="txt-explicativo">
                                <a href="<?=$resp->link_url?>"><?=$resp->link_url?></a>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="botonera text-center my-3" id="back-button">
                                    <button class="boton-continuar">
                                        Regresar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                <?php else :?>
                    <p>Hubo un error al enviar la solicitud, por favor verifique e intente nuevamente</p>
                <?php endif ?>
            </div>
        </div>
    </div>
</div>
    
<?php
    include '../footer-faq.html';
?>

<script>
    document.querySelector('#back-button').addEventListener('click',()=>{
        window.location.href = './temp/formaenvio.html';
    })
</script>

<!-- <script src="./js/script-enviolote.js?v=<?=$FILE_VER?>"></script> -->
</body>
</html>