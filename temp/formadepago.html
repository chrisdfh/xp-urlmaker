<!DOCTYPE html>
<?php
    include '../controller.php';
    
    $pago_id = isset($_GET['a']) ? $_GET['a'] : null;

    $registro = getPago($pago_id);


    $propina = $registro->monto;
    $aliado_cod = $registro->xpayctanro;
    $descripcion = $registro->concepto;
    $referencia = $registro->referencia;


    $propina_format = number_format($propina, 2, ',', '.');

    $error = false;
    if ($pago_id == null) {
        $error=true;
    };


    if ($propina == 0 || $propina == null){
        $error=true;
    }


    $aliado_cod_hash = md5('xpayctanro');


    if (!$error) {
        $aliado = $registro->aliado;
        $aliado_cod = $registro->xpayctanro;
    }

?>
<html lang="es">
<head>
    <base href="..">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XityPay</title>
    <?php include '../og.html'; ?>

    <!-- MANIFEST -->
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" type="image/x-icon" href="../favicon.ico">

    <!-- BOOTSTRAP -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- FONTAWESOME -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:ital,wght@0,100..900;1,100..900&family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">

    <!-- CSS -->
    <link rel="stylesheet" href="../css/root.css?v=<?=$FILE_VER?>">
    <link rel="stylesheet" href="../css/styles.css?v=<?=$FILE_VER?>">

    
</head>
<body>
<div class="container-fluid">

    <div class="container-mobile">
        <?php
            include '../menu-hamb.html';
        ?>

        <div class="row px-3 bg-white">
            <div class="col-4 pe-1">
                <div class="avatar-aliado border-xp mt-2">
                    <img src="<?=$aliado->url_avatar1?>" alt="LOGO <?=$aliado->nombre?>">
                </div>
                <div class="nombre-aliado"><?=$aliado->nombrecorto?></div>
            </div>
            <div class="col-8 ps-1 arialnova-font">
                <div class="d-flex" id="moneda-editable">
                    <span class="moneda-pagar-editable">Bs.</span> 
                    <div class="input-group">
                        <input type="text" id="monto-pagar-editable" inputmode="numeric" class="monto-pagar-editable w-75" value="<?=$propina?>" readonly>
                        <?php if($registro->monto_modificable=='S'):?>
                        <button class="input-group-text" onclick="editInput('monto-pagar-editable')">
                            <i class="fa-solid fa-pencil" title="Editar Monto"></i>
                        </button>
                        <?php endif; ?>
                    </div>
                </div>
                <div class="descripcion">
                    <?=$descripcion?>
                </div>
            </div>
        </div>

        <div class="row px-0">
            <div class="col-12 bg-white">
                <div class="botones-page bg-white py-2 d-none">
                    <button class="btn-page " id="btn-select-tdc" onclick="showPage(this, 'tdc-page')">
                        <div>Tarjeta</div>
                        <div>de Crédito</div>
                    </button>
                    <button class="btn-page active" id="btn-select-ti" onclick="showPage(this, 'pago-instantaneo-page')">
                        <div>Transferencia</div>
                        <div>Instantánea</div>
                    </button>
                </div>


                <div class="seccion-principal" id="seccion-principal">

                    <?php if (!$error): ?>

                        <div class="page tdc-page d-none mt-2" id="tdc-page">

                            <div class="row g-1">

                                <div class="col-12">
                                    <label for="tdcnombre">Nombre en tarjeta:</label>
                                    <input placeholder="Nombre de titular " type="text" name="tdcnombre" id="tdcnombre" class="form-control no-style fs-big" maxlength="20">
                                </div>

                                <div class="col-12">
                                    <label for="tdcnum">Número de tarjeta:</label>
                                    <input placeholder="1234 1234 1234 1234" type="number" name="tdcnum" id="tdcnum" class="form-control no-style fs-big" maxlength="20">
                                </div>

                                <div class="col-6 mt-2">
                                    <label for="tdcexp">Vencimiento:</label>
                                    <input placeholder="MM/AA" type="text" name="tdcexp" id="tdcexp" class="form-control no-style fs-big" maxlength="5">
                                </div>

                                <div class="col-6 mt-2">
                                    <label for="tdcexp">CVC:</label>
                                    <input placeholder="000" type="number" name="tdccvc" id="tdccvc" class="form-control no-style fs-big" maxlength="5">
                                </div>
                            </div>

                        </div>

                        <div class="page pago-instantaneo-page mt-2" id="pago-instantaneo-page">
                            <div class="row g-1">
                                <div class="col-12">
                                    <input type="text" name="linknro" id="linknro" class="d-none nc" value="<?=$registro->linknro?>">
                                    <label class="big-label" for="tipnip">Documento de identidad *</label>
                                    <div class="input-group gap-2">
                                        <select name="tipnip"  id="tipnip"  class="form-selec no-style pt-0 w-25 fs-big2" onselect="checkInputs()" onchange="checkInputs()">
                                            <option value="V">V</option>
                                            <option value="E">E</option>
                                            <option value="J">J</option>
                                        </select>
                                        <input type="text" inputmode="numeric" placeholder="Número de documento" name="codnip" id="codnip" class="form-control no-style fs-big2 pt-0" required onkeyup="checkInputs()">
                                    </div>
                                    <div id="e-codnip" class="d-none text-center text-danger">Número de cédula no válido</div>
                                </div>
                                <div class="col-12 mt-3">
                                    <label class="big-label" for="celcod">Teléfono celular *</label>
                                    <div class="input-group gap-2">
                                        <select name="celcod"  id="celcod"  class="form-selec no-style pt-0 w-25 fs-big2" onselect="checkInputs()" onchange="checkInputs()">
                                            <option value="">04xx</option>
                                            <option value="0412">0412</option>
                                            <option value="0414">0414</option>
                                            <option value="0424">0424</option>
                                            <option value="0416">0416</option>
                                            <option value="0426">0426</option>
                                        </select>
                                        <input type="text" inputmode="numeric" placeholder="6547895" name="celnum" id="celnum" class="form-control pt-0 no-style fs-big2" required onkeyup="checkInputs()">
                                    </div>
                                    <div id="e-celnum" class="d-none text-center text-danger">Número de teléfono no válido</div>
                                </div>
                                <div class="col-12 mt-3">
                                    <label class="big-label" for="bancocod">Banco *</label>
                                    <select name="bancocod" id="bancocod" class="form-select no-style white-style fs-big2 pt-0" required onselect="checkInputs()" onchange="checkInputs()">
                                        <option value="" selected>Seleccione Banco</option>
                                            <?php foreach (BANCOS as $banco) :?>
                                                <option value="<?=$banco['cod']?>" <?=$banco['enabled']?'':'disabled'?> ><?=$banco['cod']." - ".$banco['nombre']?></option>
                                            <?php endforeach ?>

                                    </select>
                                </div>
                                <div class="col-12 mt-3">
                                    <label class="big-label" for="email">Correo electrónico</label>
                                    <input type="email" placeholder="Correo para envío del comprobante" class="form-control pt-0  no-style fs-big2" id="email" onkeyup="checkInputs()">
                                </div>
                                <div class="col-12 mt-2 d-none">
                                    <label for="otp">Código de validación (OTP):</label>
                                    <input type="otp" placeholder="Código de validación (OTP)" class="form-control no-style pt-0" id="otp2">
                                </div>
                            </div>
                        </div>

                        <div class="row">

                            <div class="col-12 mt-3">
                                <div class="">
                                    <input type="checkbox" name="" id="guardar-datos-check" checked>
                                    <label for="guardar-datos-check">Guardar datos para la próxima vez</label>
                                </div>
                                <div class="">
                                    <input type="checkbox" name="" id="aceptar-terminos-check" onchange="checkInputs()">
                                    <label for="aceptar-terminos-check">Aceptar los <a href="#" class="text-white" target="_blank">Términos y Condiciones</a></label>
                                </div>
                            </div>
                        </div>

                        <?php if ($registro->genera_factura=='S'):?>
                        <div class="seccion-continuar mt-4 text-center" id="btn-fact">
                            <button class="boton-fp" onclick="datosFactura()">
                                <span id="facturapersonalizada">Datos de facturación</span> 
                            </button>
                        </div>
                        <?php endif ?>

                        <div class="seccion-continuar mt-2 text-center" id="btn-cont">
                            <button class="boton-continuar" disabled onclick="confirmarPago()">
                                <!-- <span id="conf-txt d-none">Confirmar <?=$aliado->moneda?> </span> <span id="cont-monto"></span>  -->
                                <span id="conf-txt">Solicitar clave de un solo uso</span> 
                            </button>
                        </div>
                        <div class="tasa-del-dia  fw-bold">
                            Los campos marcados con (*) son obligatorios
                        </div>

                        <dialog class="pago-dialog" id="otp-dialog">
                                <div class="d-flex justify-content-between">
                                    <h5>Confirmar y Enviar</h5>
                                    <button class="btn-close" onclick="dissmissDialog(this)"></button>
                                </div>

                                <div class="my-4">
                                    <table class="table on-white">
                                        <tr>
                                            <td class="colon text-end">Monto</td>
                                            <td class="fw-bold" id="otp-monto"></td>
                                        </tr>
                                        <tr>
                                            <td class="colon text-end">Cédula</td>
                                            <td class="fw-bold" id="otp-cedula"></td>
                                        </tr>
                                        <tr>
                                            <td class="colon text-end">Nro Teléfono</td>
                                            <td class="fw-bold" id="otp-tlf"></td>
                                        </tr>
                                        <tr>
                                            <td class="colon text-end">Banco</td>
                                            <td class="fw-bold" id="otp-banco"></td>
                                        </tr>
                                        <tr>
                                            <td class="colon text-end">Correo</td>
                                            <td class="fw-bold" id="otp-correo"></td>
                                        </tr>
                                    </table>
                                </div>

                                <div class="txt-dialog lh-12">
                                    Introduzca el código de validación (OTP) recibido por SMS o correo electrónico.
                                </div>
                                <form action="javascript:sendPago();">
                                <!-- <form action="javascript:;" onsubmit="ingresaOTP(this)"> -->
                                    <div class="input-group mt-3">
                                        <input type="text" autocomplete="one-time-code" inputmode="numeric" placeholder="Código de validación (OTP)" class="form-control" minlength="4" maxlength="10" id="otp">
                                       
                                    </div>

                                    <div class="fw-lighter lh-12 otp-timer-placeholder">
                                        Esta ventana se cerrará en <span id="otp-timer"></span>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="boton-continuar mt-3 w-50 fs-14"  onclick="dissmissDialog(this)">Cancelar</button>
                                        <button type="submit" class="boton-continuar mt-3 w-50 fs-14 bg-primary">Aceptar y Enviar</button>
                                    </div>
                                </form>
                        </dialog>

                        <dialog id="datos-facturacion">
                                <div class="d-flex justify-content-between">
                                    <h5>Datos de facturación</h5>
                                    <button class="btn-close" onclick="dissmissDialog(this)"></button>
                                </div>
                                <form action="javascript:;" onsubmit="regFactura(this)" class="">
                                    <div class="label-facturacion mt-3">
                                        Documento de identidad *
                                    </div>
                                    <div class="input-group">
                                        <select class="form-select w-25" name="tipnip_factura" id="tipnip_factura">
                                            <option value="V">V</option>
                                            <option value="E">E</option>
                                            <option value="J">J</option>
                                        </select>
                                        <input type="text" inputmode="numeric" placeholder="Número de documento" class="form-control w-75" name="codnip_factura" id="codnip_factura" required>
                                    </div>
                                    <div class="nombre_factura mt-3">
                                        <div class="label-facturacion">Nombre *</div>
                                        <input type="text" placeholder="Nombre" class="form-control" id="nombre_factura" name="nombre_factura" required>
                                    </div>

                                    <div class="direccion_factura mt-3">
                                        <div class="label-facturacion">Dirección *</div>
                                        <input type="text" placeholder="Dirección" class="form-control" id="direccion_factura" name="direccion_factura" required>
                                    </div>
                                    <div class="botonera mt-3 text-center">
                                        <button class="boton-fp">Aceptar</button>
                                    </div>
                                </form>
                        </dialog>

                    <?php else :?>
                        <p>Url inválido, por favor verifique e intente nuevamente</p>
                    <?php endif ?>

                </div>
            </div>
        </div>

    </div>
</div>

<div class="d-none" id="form-placeholder"></div>
<div class="d-none" id="factura-placeholder">
    <form action="javascript:;">
        <input type="text" name="cn_fact" id="cn_fact">
        <input type="text" name="tn_fact" id="tn_fact">
        <input type="text" name="nom_fact" id="nom_fact">
        <input type="text" name="dir_fact" id="dir_fact">
    </form>
</div>
<div class="d-none" id="payment-amount"><?=$propina?></div>

<!-- JS LOCAL -->
<script src="../js/script-pagolote.js?v=<?=$FILE_VER?>"></script>
<script>
    defaults(<?=$propina?>,'<?=$aliado_cod?>','<?=$persona_cod?>','<?=$registro->genera_factura?>');
</script>


<script>
    function closeDialog(e){
        // console.log(e.closest('dialog').id)
        location.href = './monto?pid=<?=$persona_cod?>';
    }
</script>


<?php include '../footer-faq.html' ?>
</body>
</html>