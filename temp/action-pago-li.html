<?php
    include '../controller.php';
    
    $aliado_cod = (isset($_POST['xpnro']) && $_POST['xpnro'] != '') ? $_POST['xpnro'] : null;
    $propina = isset($_POST['ppc']) ? $_POST['ppc'] : 0;
    $cod_cedula = isset($_POST['nac']) ? $_POST['nac'] : null;
    $cedula = isset($_POST['ced']) ? $_POST['ced'] : null;
    $cod_cel = isset($_POST['celcod']) ? $_POST['celcod'] : null;
    $num_cel = isset($_POST['celnum']) ? $_POST['celnum'] : null;
    $email = isset($_POST['email']) ? $_POST['email'] : null;
    $otp = isset($_POST['otp']) ? $_POST['otp'] : null;
    $persona_cod = (isset($_POST['pid']) && $_POST['pid'] != '') ? $_POST['pid'] : null;
    $linknro = isset($_POST['linknro']) ? $_POST['linknro'] : null;
    $fecha = date('d/m/Y h:i a', time());

    $banco = isset($_POST['ban']) ? $_POST['ban'] : null;
    $banco_nombre = isset($_POST['ban_nombre']) ? $_POST['ban_nombre'] : null;

    $propina_format = number_format($propina, 2, ',', '.');

    // $aliado_cod_hash = isset($_GET['a'])?$_GET['a']:null;
    // $aliado_cod = getAliadoCod($aliado_cod_slug);

    $error = false;
    if ($aliado_cod == null) {
        $error=true;
    };

    // if (!$error) {
    //     $aliado = getAliadoData($aliado_cod_hash,$persona_cod);
    //     $aliado_cod = $aliado->xpayctanro;como 
    // }

    $pago_info = getPago(md5($linknro));

    $confirmacion = sendPaymentFromLote($persona_cod,$email,$aliado_cod,$propina,'VES',$pago_info->concepto,$otp,$cod_cedula,$cedula,$banco,"$cod_cel$num_cel",$linknro);
    $nro_confirmacion = $confirmacion->transaction_id;


?>
<!DOCTYPE html>
<html lang="en">
<head>
    <base href=".">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagando</title>

    <!-- MANIFEST -->
    <link rel="manifest" href="../manifest.json" />
    <link rel="icon" type="image/x-icon" href="../favicon.ico">

    <!-- BOOTSTRAP -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- FONTAWESOME -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:ital,wght@0,100..900;1,100..900&family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">

    <!-- CSS -->
    <link rel="stylesheet" href="../css/root.css?v=<?=$FILE_VER?>">
    <link rel="stylesheet" href="../css/styles.css?v=<?=$FILE_VER?>">
    
<style>
    body{
        background-color: white !important;
        min-height: 100svh !important;
        place-content: center;
        display: grid;
        font-size: 1.5em;
        font-weight: 700;
    }
</style>

</head>
<body class="">

<div class="pagando">
    Realizando pago <i class="fa-solid fa-spinner fa-spin-pulse"></i>
</div>



<form action="/confirmado" method="post" class="d-none">
    <input type="number" name="ppc" value="<?=$propina?>">
    <input type="text" name="nac" value="<?=$cod_cedula?>">
    <input type="text" name="fecha" value="<?=$fecha?>" >
    <input type="text" name="ced" value="<?=$cedula?>" >
    <input type="text" name="celcod" value="<?=$cod_cel?>" >
    <input type="text" name="celnum" value="<?=$num_cel?>" >
    <input type="text" name="email" value="<?=$email?>" >
    <input type="text" name="ban" value="<?=$banco?>" >
    <input type="text" name="ban_nombre" value="<?=$banco_nombre?>" >
    <input type="text" name="nro_confirmacion" value="<?=$nro_confirmacion?>" >
    <input type="text" name="pid" value="<?=$persona_cod?>" >
    <input type="text" name="linknro" value="<?=$linknro?>" >
    <input type="text" name="aliado_cod" value="<?=$aliado_cod?>" >
</form>
<script>
    setTimeout(() => {
        document.querySelector("form").submit();
    }, 200);
</script>
</body>
</html>