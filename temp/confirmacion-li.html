<!DOCTYPE html>
<?php
    include '../controller.php';

    
    $propina = isset($_POST['ppc']) ? $_POST['ppc'] : 0;
    $cod_cedula = isset($_POST['nac']) ? $_POST['nac'] : null;
    $cedula = isset($_POST['ced']) ? $_POST['ced'] : null;
    $cod_cel = isset($_POST['celcod']) ? $_POST['celcod'] : null;
    $num_cel = isset($_POST['celnum']) ? $_POST['celnum'] : null;
    $email = isset($_POST['email']) ? $_POST['email'] : null;
    $otp = isset($_POST['otp']) ? $_POST['otp'] : null;
    $persona_cod = isset($_POST['pid']) ? $_POST['pid'] : null;
    $nro_confirmacion = isset($_POST['nro_confirmacion']) ? $_POST['nro_confirmacion'] : null;
    $fecha = isset($_POST['fecha']) ? $_POST['fecha'] : null;

    $linknro = isset($_POST['linknro']) ? $_POST['linknro'] : null;

    $banco = isset($_POST['ban']) ? $_POST['ban'] : null;
    $banco_nombre = isset($_POST['ban_nombre']) ? $_POST['ban_nombre'] : null;

    $propina_format = number_format($propina, 2, ',', '.');

    $aliado_cod = (isset($_POST['aliado_cod']) && $_POST['aliado_cod'] != '')? $_POST['aliado_cod'] : null;
    // $aliado_cod = getAliadoCod($aliado_cod_slug);

    $error = false;
    $shareTxt = '';
    if ($aliado_cod == null) {
        $error=true;
    };


    if ($nro_confirmacion == null || $nro_confirmacion == '') {
        $error=true;
    }

    $error = false;

    if (!$error) {
        $datosPagoLink = getPago(md5($linknro));
        
        $shareTxt = "Referencia: $nro_confirmacion %0a".
        "Fecha: $fecha %0a".
        "Cédula Origen: $cedula %0a".
        "Teléfono: ($cod_cel) $num_cel %0a".
        "Correo: $email %0a".
        "Banco Origen: $banco %0a".
        "Destino: $aliado->nombre %0a".
        "Monto: $aliado->moneda $propina_format %0a%0a".
        "¡Tu transferencia instantánea está en camino!%0a%0a".
        "Has ordenado una transferencia instantánea por $aliado->moneda $propina_format a $aliado->nombre%0a%0a".
        "Esto no es un comprobante de la transferencia.%0a%0a".
        "Estamos procesando tu transacción y hemos enviado los datos suministrados a tu banco. En breve debes recibir una notificación formal del resultado de la transacción. %0a%0a".
        "Para tu mayor tranquilidad, también puedes corroborar el movimiento en tu cuenta bancaria.";
    }


?>
<html lang="es">
<head>
    <base href="./">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <?php include '../og.html'; ?>

    <!-- MANIFEST -->
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" type="image/x-icon" href="../favicon.ico">

    <!-- BOOTSTRAP -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- FONTAWESOME -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:ital,wght@0,100..900;1,100..900&family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">

    <!-- CSS -->
    <link rel="stylesheet" href="../css/root.css?v=<?=$FILE_VER?>">
    <link rel="stylesheet" href="../css/styles.css?v=<?=$FILE_VER?>">
    <link rel="stylesheet" href="../css/confirmacion.css?v=<?=$FILE_VER?>">

    
</head>
<body>
<div class="container-fluid">

    <div class="container-mobile">
        
        <?php
            include '../menu-hamb.html';
        ?>

        <div class="row px-3 bg-white">
            <div class="col-12">

                <div class="stepper-line z-1 position-relative">
                    <ol class="stepper p-0">
                        <li class="active">Monto</li>
                        <li class="active">Enviar</li>
                        <li class="<?=$error?'':'active'?>">Comentar</li>
                    </ol>
                </div>
            </div>
        </div>

        <div class="row px-3 bg-white">
            <div class="col-12">
                <div class="avatar-aliado d-none">
                    <img src="<?=$datosPagoLink->aliado->url_avatar1?>" alt="<?=$datosPagoLink->aliado->nombrecorto?>">
                </div>

                <div class="monto-pagar">
                    Bs. <span><?=$propina_format?></span>
                </div>

                <div class="nombre-aliado mt-0"><?=$datosPagoLink->aliado->nombrecorto?></div>
                <div class="descrip-aliado mb-1"><?=$datosPagoLink->concepto?></div>
            </div>
        </div>


        <div class="row px-0">
            <div class="col-12 bg-white">


                <div class="seccion-principal" id="seccion-principal">
                    <div class="mt-2">
                        <div class="row">

                            <?php if (!$error): ?>
                                <div class="col-12">
                                    <table class="table bg-transparent">
                                        <tr>
                                            <td class="td-1 pe-2">Referencia</td>
                                            <td class="td-2 ps-2"><?=$nro_confirmacion?></td>
                                        </tr>
                                        <tr>
                                            <td class="td-1 pe-2">Fecha</td>
                                            <td class="td-2 ps-2"><?=$fecha?></td>
                                        </tr>
                                        <tr>
                                            <td class="td-1 pe-2">Cédula Origen</td>
                                            <td class="td-2 ps-2"><?=$cod_cedula.'-'.$cedula?></td>
                                        </tr>  
                                        <tr>
                                            <td class="td-1 pe-2">Teléfono</td>
                                            <td class="td-2 ps-2"><?="($cod_cel) $num_cel"?></td>
                                        </tr>  
                                        <tr class="<?=(!$email)?'d-none':''?>">
                                            <td class="td-1 pe-2">Correo</td>
                                            <td class="td-2 ps-2"><?=$email?></td>
                                        </tr>  
                                        <tr>
                                            <td class="td-1 pe-2">Banco Origen</td>
                                            <td class="td-2 ps-2"><?=$banco_nombre?></td>
                                        </tr>  
                                        <tr>
                                            <td class="td-1 pe-2">Destino</td>
                                            <td class="td-2 ps-2"><?=$datosPagoLink->aliado->nombrecorto?></td>
                                        </tr>  
                                        <tr>
                                            <td class="td-1 pe-2">Monto</td>
                                            <td class="td-2 ps-2">Bs. <span id="pay-amount"><?=$propina_format?></span></td>
                                        </tr>  
                                    </table>
                                    <div class="mt-4 lh-12">
                                        <div class="msg-enviado">
                                            <!-- Su transferencia instantánea ha sido ordenada. En pocos minutos <strong><?=$aliado->moneda?> <?=$propina_format?></strong> deben ser depositados en la cuenta de <strong><?=$aliado->nombre?></strong>. Una vez que la transacción haya sido completada y hayamos recibido la notificación del banco, le haremos llegar un mensaje de confirmación al correo suministrado. -->
                                             <div class="fw-bold fs-18">
                                                ¡Tu transferencia instantánea está en camino!
                                             </div>
                                             <div class="mt-2">
                                                Has ordenado una transferencia instantánea por Bs. <?=$propina_format?> a <?=$aliado->nombre?> 
                                             </div>
                                             <div class="mt-2">
                                                Estamos procesando tu transacción y hemos enviado los datos suministrados a tu banco. En breve debes recibir una notificación formal del resultado de la transacción. 
                                             </div>
                                             <div class="mt-2">
                                                Para tu mayor tranquilidad, también puedes corroborar el movimiento en tu cuenta bancaria.
                                             </div>
                                        </div>
                                    </div>

                                    <div class="calificacion mt-3">
                                        <div class="porta-estrellas d-flex justify-content-center">
                                            <div class="">
                                                Valorar
                                            </div>
                                            <i class="fa-regular fa-star" data-value="1" id="star-1"></i>
                                            <i class="fa-regular fa-star" data-value="2" id="star-2"></i>
                                            <i class="fa-regular fa-star" data-value="3" id="star-3"></i>
                                            <i class="fa-regular fa-star" data-value="4" id="star-4"></i>
                                            <i class="fa-regular fa-star" data-value="5" id="star-5"></i>
                                        </div>
                                        <textarea placeholder="Agrega un comentario (opcional)" class="form-control mt-2 text-area d-none" id="comentario"></textarea>
                                        <div class="text-center">
                                            <button class="boton-continuar mt-3 d-none" id="btn-calificar">Enviar Valoración</button>
                                        </div>
                                    </div>

                                    <dialog id="share-dialog">
                                        <div class="text-center">
                                            <h4>Compartir comprobante</h4>
                                            <div class="share-icons">
                                                <div class="rrss-box">
                                                    <a id="ws" href="https://wa.me?text=<?=$shareTxt?>" target="_blank"><i class="fa-brands fa-whatsapp"></i>
                                                    <div class="rrss-txt">
                                                        WhatApp
                                                    </div>
                                                </a>
                                                </div>
                                                <div class="rrss-box">
                                                    <a id="em" href="mailto:?subject=Pago XityPay (<?=$aliado->nombre?>)&body=<?=$shareTxt?>" target="_blank"><i class="fa-regular fa-envelope"></i>
                                                    <div class="rrss-txt">
                                                        Email
                                                    </div>
                                                </a>
                                                </div>
                                                <div class="rrss-box">
                                                    <a id="tg" href="https://t.me/share/url?url=https://xitypay.com&text=<?=$shareTxt?>" target="_blank"><i class="fa-brands fa-telegram"></i>
                                                    <div class="rrss-txt">
                                                        Telegram
                                                    </div>
                                                </a>
                                                </div>
                                            </div>
                                        </div>
                                    </dialog>
                                </div>
                            <?php else: ?>
                                <div class="col-12">
                                    HUBO UN ERROR AL PROCESAR EL PAGO, POR FAVOR INTENTE NUEVAMENTE MAS TARDE
                                </div>
                            <?php endif; ?>

                        </div>

                    </div>
                    <?php if (!$error): ?>
                        <div class="seccion-continuar mt-4 text-center" id="btn-cont">
                            <button class="boton-continuar" onclick="shareComprobante()">
                                <i class="fa-solid fa-share-nodes"></i> Compartir
                            </button>
                            <button class="boton-continuar" onclick="homePago('<?=$persona_cod?>')">
                                <span id="conf-txt">Listo</span> 
                            </button>
                        </div>
                    <?php else: ?>
                        <div class="seccion-continuar mt-4 text-center" id="btn-cont">
                            <button class="boton-continuar" onclick="homePago('<?=$persona_cod?>')">
                                <span id="conf-txt">Intentar Nuevamente</span> 
                            </button>
                        </div>
                    <?php endif?>
                </div>
            </div>
        </div>

    </div>
</div>


<div class="d-none" id="payment-amount"><?=$propina?></div>

<!-- JS LOCAL -->
<script src="../js/script-conf.js?v=<?=$FILE_VER?>"></script>



<?php include '../footer-faq.html' ?>
</body>
</html>