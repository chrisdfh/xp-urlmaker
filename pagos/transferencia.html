<!DOCTYPE html>
<html lang="es-VE">
<head>
    <base href="..">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<?php   
    include '../controller.php';
    serverInfo();

    $error_msg="Url inválido, por favor verifique e intente nuevamente.";

    // $aliado = getAliadoData($aliado_cod,$persona_cod);

    // $personas = getPersonasFromXpayctanro($aliado->xpayctanro);

    // $array_usuario_nropersona = array_column($personas->results, 'nropersona');
    // $aliado_nropersona = $personas->results[0]->cuenta->nropersona;

    // $key_nropersona = array_search($aliado->persona->nropersona, $array_usuario_nropersona);

    // if(!is_numeric($key_nropersona)) {
    //     $persona_cod = $aliado_nropersona;
    // }

    $url = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? "https" : "https") . "://" . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];
    if($error){
        $error_msg="Error de configuración";
    }
    else{
        $data_enlace=consulta_enlace($url);
    }

    if(!isset($data_enlace->ciaopr)){
        $error=true;
    }

    $xpayctanro = $data_enlace->xpayctanro;
    $layout = getLayout($xpayctanro);
    if ($layout){
        $logo_url = $data_enlace->url_avatar1;
        $bg_url = $layout->styles->backgroundImage;
    }

    $minutes = 60;

    // var_dump($data_enlace)

// {
//   "ciaopr": "1",
//   "xpayctanro": "X000000072",
//   "nropersona": 1544,
//   "url_avatar1": "https://wallpapers.com/images/hd/generic-male-avatar-icon-piiktqtfffyzulft.jpg",
//   "bancocod": "0134",
//   "bancoctatipo": "CELE",
//   "bancocta_tipnip": "V",
//   "bancocta_codnip": "15631160",
//   "cta_titular_nombre": "De Freitas Christian XP",
//   "bancoctanro": "04122841442",
//   "cuenta": {
//     "concepto_x_defecto": "Pago inmediato",
//     "nombre": "XITYCLUB"
//   },
//   "persona": {},
//   "fch_expiracion": "2026-05-21T02:04:01.003433-04:00",
//   "tasa": {
//     "currency": "USD",
//     "monto_ves": 214.41
//   }
// }

?>

    <title>Solicitud de Transferencia</title>

    <!-- MANIFEST -->
    <link rel="manifest" href="./manifest.json" />
    <link rel="icon" type="image/x-icon" href="./favicon.ico">

    <!-- BOOTSTRAP -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- FONTAWESOME -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:ital,wght@0,100..900;1,100..900&family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">

    <!-- CSS -->
    <link rel="stylesheet" href="./css/root.css?v=<?=$FILE_VER?>">
    <link rel="stylesheet" href="./css/styles.css?v=<?=$FILE_VER?>">
    <link rel="stylesheet" href="./css/enviolote.css?v=<?=$FILE_VER?>">

    <!-- JS -->
    <script src="./js/script-transferencia.js?v=<?=$FILE_VER?>"></script>
    <script src="./js/util.js?v=<?=$FILE_VER?>"></script>

    <?php if (isset($layout->styles)){
        include '../xp-styles.html';
    } ?>
    <style>
        body{
                grid-template-rows: 1fr auto;
                display: grid;
        }
        .input-group{
            padding:0;
            overflow: hidden;
        }

        .seccion-ml .title-seccion-ml{
            text-transform: none;
        }
        .label-il{
            margin-left:5px;
            /* width: 9ch; */
        }

        input:checked + label.button-label {
            background-color: <?=$layout->styles->activeButtonColor?> !important;
            color: <?=$layout->styles->activeButtonTextColor?> !important;
            border: 1px solid <?=$layout->styles->activeButtonColor?>;
        }


    </style>
</head>
<body>


<div class="container-fluid main-bg">

<div class="container-mobile">
    
    <?php
        include '../menu-hamb.html';
    ?>

    <div class="row px-0">
        <div class="col-12">
            <div class="mt-2">
                <?php if (!$error) : ?>
                    <div class="seccion-ml">
                        <div class="title-seccion-ml lh-12 mt-3">
                            Solicitar Débito Inmediato
                        </div>

                        <div class="pec-bubble">
                            <div class="name-bubble text-center">
                                <?=$data_enlace->cta_titular_nombre?>
                            </div>
                        </div>

                        <div class="body-seccion-ml p-2">
                            <form action="/pagos/solicitudenviada.html" method="post">
                            <!-- <form action="javascript:void(0)" method="post"> -->
                                <div class="row ">

                                    <div class="d-none">
                                        <input type="text" class="nc" name="tipo_enlace" value="I">
                                        <input type="text" class="nc" name="xpayctanro" value="<?=$data_enlace->xpayctanro?>">
                                        <input type="text" class="nc" name="nrousuario" value="<?=$user_id?>">
                                        <input type="text" class="nc" name="nropersona" value="<?=$data_enlace->nropersona?>">
                                        <input type="text" class="nc" name="nombre_aliado" value="<?=$data_enlace->cuenta->nombre?>">
                                    </div>

                                    <!-- <div class="col-6 offset-6">
                                        <div class="cuadro-input">
                                            <label for="monto" class=" big-label fs-14">
                                                <div class="d-flex gap-3">
                                                    <div class="txt">Monto</div>
                                                    <div class="d-flex gap-1 align-items-center">
                                                        <label for="montosi">Si:</label>
                                                        <input class="d-block monto-radio" type="radio" name="lleva_monto" value="S" id="montosi" checked>
                                                    </div>

                                                    <div class="d-flex gap-1 align-items-center">
                                                        <label for="montono">No:</label>
                                                        <input class="d-block monto-radio" type="radio" name="lleva_monto" value="N" id="montono">
                                                    </div>
                                                    
                                                    <div class="d-flex gap-1 align-items-center">
                                                        <label for="abiertocheck">Abierto:</label>
                                                        <input class="d-block" type="checkbox" name="monto_modificable" id="abiertocheck">
                                                    </div>
                                            
                                                </div>
                                            </label>


                                        </div>
                                    </div> -->


                                    <div class="col-12">
                                        <div class="d-flex">
                                            <div class="pe-1">
                                                <div class="d-flex gap-1 align-items-center justify-content-end">
                                                    <label class=" big-label fs-14" for="lleva_monto">Lleva monto:</label>
                                                    <input class="d-block" type="checkbox" name="lleva_monto" id="lleva_monto">
                                                </div>
                                            </div>
                                            <div class="ps-1">
                                                <div class="d-flex gap-1 align-items-center justify-content-end">
                                                    <label class=" big-label fs-14" for="abiertocheck">Monto abierto:</label>
                                                    <input class="d-block" type="checkbox" name="monto_modificable" id="abiertocheck">
                                                </div>
                                            </div>
                                        </div>
                                    </div>


                                    <div class="col-6 pe-0">
                                        <div class="cuadro-input">
                                            <div class="input-group">
                                                <input id="monto" name="monto" type="text" inputmode="decimal" class="form-control"  placeholder="Monto"  onkeyup="setMontoRate(this)"> 
                                                <input name="monto-final" type="text" class="d-none" id="monto-final">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-3 pe-1">
                                        <input type="radio" name="moneda" data-value="vef" value="vef" id="vef" checked>
                                        <label class="button-label sm" for="vef">Bs.</label>
                                    </div>
                                    <div class="col-3 ps-1">
                                        <input type="radio" name="moneda" data-value="usd" value="usd" id="usd">
                                        <label class="button-label sm" data-value="usd" for="usd">$</label>
                                    </div>
                                    <div class="col-12">
                                        <div class="tasa-del-dia d-none">
                                            Tasa BCV del día Bs. <?=$data_enlace->tasa->monto_ves?>
                                        </div>
                                    </div>
                                </div>


                                <!-- ############################# -->


                                <!-- ############################# -->

                                <div class="row">


                                    <div class="col-12">
                                        <div class="cuadro-input">
                                            <label class=" big-label">
                                                Por concepto de
                                            </label>
                                            <textarea placeholder="Por concepto de..." class="form-control" name="concepto" id="concepto" required onkeyup="normalizeInputValue(this)" onblur="normalizeInputValue(this)"><?=$data_enlace->cta_titular_nombre?><?=($data_enlace->cuenta->concepto_x_defecto==''?'':' - '.$data_enlace->cuenta->concepto_x_defecto)?></textarea>
                                        </div>
                                    </div>


                                    <div class="col-12">
                                        <div class="cuadro-input">
                                            <label class=" big-label">
                                                Referencia del aliado
                                            </label>
                                            <div class="input-group">
                                                <input oninput="let p = this.selectionStart; this.value = this.value.toUpperCase();this.setSelectionRange(p, p);" name="referencia" id="referencia" type="text" class="form-control" placeholder="123456ABCDE" required>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-12 mt-2">
                                        <div class="input-box">
                                                <label class=" big-label fs-14 ps-1">
                                                    Enviar por: (Se pueden dejar en blanco)
                                                </label>

                                        <div class="col-12">
                                            <div class="cuadro-input">
                                                <div class="d-flex align-items-center ">
                                                    <!-- <input type="checkbox" class=" " name="ws" id="ws" onchange="toggleDisbled(this, 'telefono','codtel')"> -->
                                                    <label for="ws" class=" big-label label-il ps-2">
                                                        WhatsApp, SMS, Telegram:
                                                    </label>
                                                </div>
                                                <style>
                                    
                                                </style>
                                                <div class="input-group">
                                                    <select name="codtel" id="codtel" class="form-select">
                                                        <option value="" selected disabled>04xx</option>
                                                        <option value="0412">0412</option>
                                                        <option value="0422">0422</option>
                                                        <option value="0414">0414</option>
                                                        <option value="0424">0424</option>
                                                        <option value="0416">0416</option>
                                                        <option value="0426">0426</option>

                                                    </select>
                                                    <input id="telefono" name="telefono" type="text" inputmode="tel" class="form-control" placeholder="XXXXXXX" maxlength="7" minlength="7">
                                                </div>
                                            </div>
                                            <!-- <label class="tip">Agregue el número de teléfono si no lo posee en sus contactos</label> -->
                                            
                                        </div>
                                        <div class="col-12">
                                            <div class="cuadro-input">
                                                <!-- <label class=" big-label">
                                                    Correo
                                                </label> -->

                                                <div class="d-flex align-items-center">
                                                    <!-- <input type="checkbox" class=" " name="sbm" id="sbm" onchange="toggleDisbled(this, 'email_notificacion')"> -->
                                                    <label for="sbm" class=" big-label label-il ps-2">
                                                        E-mail:
                                                    </label>
                                                </div>
                                                <div class="input-group">
                                                    <input name="email_notificacion" type="email" inputmode="email" class="form-control" placeholder="correo@dominio.com">
                                                </div>
                                            </div>
                                            
                                        </div>
                                        </div>
                                    </div>

                                    <div class="col-6 pe-1">
                                        <div class="cuadro-input">
                                            <label class=" big-label flex-shrink-0 pe-3 align-content-center">
                                                Tiempo de expiración:
                                            </label>
                                            <div class="input-group">
                                                <input name="vigencia" inputmode="numeric" id="vigencia" type="text" class="form-control" placeholder="15" required>
                                                <span class="input-group-text bg-white b-0">Minutos</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-6 d-none">
                                        <div class="cuadro-input">
                                            <label class=" big-label">
                                                Fecha de Envío
                                            </label>
                                            <div class="input-group">
                                                <input name="fchemision" type="datetime-local" class="form-control" placeholder="DD / MM / YYYY">
                                            </div>
                                        </div>
                                        
                                    </div>
                                    <div class="col-6 ps-1">

                                        <div class="cuadro-input">
                                            <label class=" big-label">
                                                Fecha de Caducidad
                                            </label>
                                            <div class="input-group">
                                                <input name="fchcaducidad" type="datetime-local" class="form-control nc" placeholder="DD / MM / YYYY">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-12 mt-4">
                                        <div class="text-center">
                                            <button class="boton-continuar" id="enviarLote" >Generar y enviar <span></span></button>
                                        </div>
                                    </div>

                                    <div class="tasa-del-dia color-azul-principal fw-semibold c-pointer" data-bs-toggle="offcanvas" href="#footer-faq">
                                        <i class="fa-regular fa-circle-question pe-2"></i> <div class="d-inline">Preguntas Frecuentes</div>
                                    </div>
                                </div>
                             </form>
                        </div>
                    </div>
                <?php else :?>
                    <p>Url inválido, por favor verifique e intente nuevamente</p>
                <?php endif ?>
            </div>
        </div>
    </div>
</div>
</div>
    
<?php
    include '../footer-faq.html';
?>
<script>


    const xpaycta = '<?=$data_enlace->xpayctanro?>';
    const aliadoLS = localStorage.getItem('xpr')

    // async function getAliadoJWT(xpaycta,aliadoLS){
    //     const payload = JSON.stringify({
    //         xpayctanro:xpaycta,
    //         jwt:aliadoLS
    //     })

    //     const url = '/php/aliado-from-jwt.php'
    //     const response = await fetch(url, {
    //         method: 'POST',
    //         headers: {
    //             'Content-Type': 'application/json'
    //         },
    //         body: payload
    //     });
    //     const respJson = await response.json()
    //     aliadoDOM(respJson)
    // }
    function aliadoDOM(aliado){

        document.querySelector('input[name="xpayctanro"]').value = aliado.active_xpaycta.xpayctanro
        document.querySelector('input[name="nrousuario"]').value = aliado.usuario.nrousuario
        document.querySelector('input[name="nombre_aliado"]').value = aliado.active_xpaycta.nombrepersjuridica
        document.querySelector('input[name="nropersona"]').value = aliado.usuario.nropersona

    }

    // getAliadoJWT(xpaycta,aliadoLS)


    function toggleDisbled(input, ...names){
        names.forEach(name => {
            if (input.checked){
                document.querySelector('[name="'+name+'"]').disabled = false
            } else {
                document.querySelector('[name="'+name+'"]').disabled = true
            }
        });

    }


    document.querySelector('input#monto').onkeydown = (event)=>{

        if (event.key === ',' || event.key === '.'){
            event.preventDefault()
            event.target.value += '.'
            return
        }
        if (isNaN(event.key) && event.key != 'Backspace') {
            event.preventDefault()
        }

    }

    document.querySelector('input#monto').onblur = (event)=>{
        event.target.value = event.target.value.replace(/\,/g, '.')
        inputMonto(event)
    }

    setDefaults({r: <?=$data_enlace->tasa->monto_ves?>})

    const vigencia = <?=$minutes?>;

    // SI USO ATRAS EN EL NAVEGADOR, REFRESCA LA PAGINA
    (function() {
        window.onpageshow = function(event) {
            var historyTraversal = event.persisted || 
            ( window.performance.getEntriesByType("navigation")[0].type === "back_forward" );

            if ( historyTraversal ) {
                window.location.reload();
            }
        }
    })();








</script>
<style>
    .form-control:focus,
    .form-select:focus {
        box-shadow: inset 0 0 0 3px #86b7fe !important;
    }

    .form-control,
    .form-select {
        border: 1px solid rgb(158,158,158) !important;
    }
</style>
</body>
</html>